<html>
  <head>
    <style>
      .game {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .hand-container {
        height: 160px;
        display: flex;
        justify-content: space-around;
        width: 100%;
      }
      .player-hand {
        display: flex;
      }
      .player-hand.active {
        background: #eee;
      }
      .play-container {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .play-side {
        display: flex;
        flex-wrap: wrap;
        min-width: 620px;
        max-width: 620px;
      }
      .play-side.active {
        background: #eee;
      }
      #team-2 {
        justify-content: end;
      }
      .gap {
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 120px;
      }
      .card {
        position: relative;
        width: 100px;
        height: 140px;
        margin: 8px;
        border: solid 5px #ccc;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        user-select: none;
        font-size: 60px;
        box-sizing: border-box;
      }
      .card.active {
        border-color: #3157d5
      }
      .card.valid {
        border-color: #31d589
      }
      .card.invalid {
        border-color: #f04a38;
      }
      .point-value {
        position: absolute;
        bottom: 8px;
        right: 8px;
        font-size: 16px;
      }
      .google-sheets-letter-container {
        margin: 10px;
        display: flex;
        justify-content: space-between;
        width: 180px;
      }
      .google-sheets-letter-container input {
        width: 40px;
      }
    </style>
  </head>
  <body>
    <label>Number of players:</label><input step=2 type="number" id="number-of-players" />
    <label>Number of cards in hand:</label><input type="number" id="number-of-cards-in-hand" />
    <div class="game">
      <div class="hand-container top"></div>
      <div class="play-container">
        <div id="team-1" class="play-side active">
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
        </div>
        <div class="gap">
          <h1 id="valid-word"></h1>
          <p id="valid-word-definition"></p>
        </div>
        <div id="team-2" class="play-side">
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
          <div class="card board"><div class="letter"></div><div class="point-value"></div></div>
        </div>
      </div>
      <div class="hand-container bottom"></div>
    </div>
    <button id="get-google-sheets-data">Get Google Sheets Data</button>
    <button id="update-on-this-computer">Update On This Computer</button>
    <button id="update-in-google-sheets">Update In Google Sheets</button>
    <div id="google-sheets-letters-container"></div>
  </body>
  <script>
    window.onload = () => {
      playSides = Array.from(document.getElementsByClassName('play-side'))
      boardCards = Array.from(document.getElementsByClassName('card board'))
      handContainerElements = Array.from(document.getElementsByClassName('hand-container'))
      validWordElement = document.getElementById('valid-word')
      validWordDefinitionElement = document.getElementById('valid-word-definition')
      numberOfPlayersInput = document.getElementById('number-of-players')
      numberOfCardsInHandInput = document.getElementById('number-of-cards-in-hand')
      getGoogleSheetDataButton = document.getElementById('get-google-sheets-data')
      updateOnThisComputerButton = document.getElementById('update-on-this-computer')
      updateInGoogleSheetsButton = document.getElementById('update-in-google-sheets')
      googleSheetsLettersContainer = document.getElementById('google-sheets-letters-container')
      numberOfTeams = 2
      activePlayer = 0
      activeTeam = 0
      validWord = ''
      validWordDefinition = ''
      NUMBER_OF_PLAYERS_KEY = 'numberOfPlayers'
      NUMBER_OF_CARDS_IN_HAND_KEY = 'numberOfCardsInHand'
      GOOGLE_SHEETS_LETTERS_KEY = 'googleSheetsLetters'
      ORIGINAL_LETTERS = [
        { letter: 'A', frequency: 9, point_value: 1 },
        { letter: 'B', frequency: 2, point_value: 3 },
        { letter: 'C', frequency: 2, point_value: 3 },
        { letter: 'D', frequency: 5, point_value: 2 },
        { letter: 'E', frequency: 12, point_value: 1 },
        { letter: 'F', frequency: 2, point_value: 4 },
        { letter: 'G', frequency: 3, point_value: 2 },
        { letter: 'H', frequency: 2, point_value: 4 },
        { letter: 'I', frequency: 9, point_value: 1 },
        { letter: 'J', frequency: 1, point_value: 8 },
        { letter: 'K', frequency: 1, point_value: 5 },
        { letter: 'L', frequency: 4, point_value: 1 },
        { letter: 'M', frequency: 2, point_value: 3 },
        { letter: 'N', frequency: 6, point_value: 1 },
        { letter: 'O', frequency: 8, point_value: 1 },
        { letter: 'P', frequency: 2, point_value: 3 },
        { letter: 'Q', frequency: 1, point_value: 10 },
        { letter: 'R', frequency: 6, point_value: 1 },
        { letter: 'S', frequency: 5, point_value: 1 },
        { letter: 'T', frequency: 6, point_value: 1 },
        { letter: 'U', frequency: 4, point_value: 1 },
        { letter: 'V', frequency: 2, point_value: 4 },
        { letter: 'W', frequency: 2, point_value: 4 },
        { letter: 'X', frequency: 1, point_value: 8 },
        { letter: 'Y', frequency: 2, point_value: 4 },
        { letter: 'Z', frequency: 1, point_value: 10 }
      ]
      LETTERS = JSON.parse(JSON.stringify(ORIGINAL_LETTERS))
      const httpGet = (url) => {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", url, false);
        xmlHttp.send(null);
        return xmlHttp.responseText;
      }
      const setNumberOfPlayers = (num) => {
        localStorage.setItem(NUMBER_OF_PLAYERS_KEY, num)
      }
      const getNumberOfPlayers = () => {
        num = localStorage.getItem(NUMBER_OF_PLAYERS_KEY)
        if (!num) {
          num = 4
          setNumberOfPlayers(num)
        }
        return num
      }
      const setNumberOfCardsInHand = (num) => {
        localStorage.setItem(NUMBER_OF_CARDS_IN_HAND_KEY, num)
      }
      const getNumberOfCardsInHand = () => {
        num = localStorage.getItem(NUMBER_OF_CARDS_IN_HAND_KEY)
        if (!num) {
          num = 3
          setNumberOfCardsInHand(num)
        }
        return num
      }
      const setupHands = () => {
        handContainerElements.forEach(e => {
          e.innerHTML = null
        })
        boardCards.forEach(c => {
          Array.from(c.children).forEach(c => {
            c.innerHTML = null
          })
        })
        for (let i = 0; i < getNumberOfPlayers(); i++) {
          handElement = document.createElement('div')
          handElement.classList.add('player-hand')
          if (i === 0) {
            handElement.classList.add('active')
          }
          for (let j = 0; j < getNumberOfCardsInHand(); j++) {
            handCardElement = document.createElement('div')
            handCardElement.classList.add('card', 'hand')
            letterElement = document.createElement('div')
            letterElement.classList.add('letter')
            pointValueElement = document.createElement('div')
            pointValueElement.classList.add('point-value')
            handCardElement.appendChild(letterElement)
            handCardElement.appendChild(pointValueElement)
            handElement.appendChild(handCardElement)
          }
          nthHandContainer = (i % 2) ? 1 : 0
          document.getElementsByClassName('hand-container')[nthHandContainer].appendChild(handElement)
        }

        numberOfPlayersInput.value = getNumberOfPlayers()
        numberOfCardsInHandInput.value = getNumberOfCardsInHand()
      }
      numberOfPlayersInput.addEventListener('change', e => {
        num = e.target.value
        if (num && num % 2 === 0) {
          setNumberOfPlayers(num)
          resetBoard()
        }
      })
      numberOfCardsInHandInput.addEventListener('change', e => {
        num = e.target.value
        setNumberOfCardsInHand(num)
        resetBoard()
      })
      getGoogleSheetDataButton.addEventListener('click', () => {
        getGoogleSheetData()
      })
      updateOnThisComputerButton.addEventListener('click', () => {
        updateLettersLocally()
      })
      updateInGoogleSheetsButton.addEventListener('click', () => {
        updateLettersRemotely()
      })
      const incrementTurn = () => {
        activePlayer = (activePlayer + 1) % getNumberOfPlayers()
        activeTeam = (activeTeam + 1) % numberOfTeams

        activeTeamElement = document.getElementById(activeTeam ? 'team-2' : 'team-1')
        inactiveTeamElement = document.getElementById(activeTeam ? 'team-1' : 'team-2')
        activeTeamElement.classList.add('active')
        inactiveTeamElement.classList.remove('active')

        activePlayerElement = document.getElementsByClassName('player-hand active')[0]
        nextPlayerElement = document.getElementsByClassName('player-hand')[activePlayer]
        activePlayerElement.classList.remove('active')
        nextPlayerElement.classList.add('active')
      }
      const chooseRandomLetter = (card) => {
        frequencySum = 0
        LETTERS.forEach(char => {
          frequencySum += char.frequency
        })
        randomIndex = Math.ceil(Math.random() * frequencySum)
        tempSum = 0
        letter = false
        LETTERS.forEach(l => {
          tempSum += l.frequency
          if (tempSum >= randomIndex && !letter && l.frequency > 0) {
            letter = l
            l.frequency -= 1
          }
        })

        card.classList.remove('active')
        card.children[0].innerHTML = letter?.letter || ''
        card.children[1].innerHTML = letter?.point_value || ''
      }
      const placeCard = (boardCard, handCard) => {
        boardCard.innerHTML = handCard.innerHTML
        chooseRandomLetter(handCard)
        incrementTurn()
      }
      const getRowText = (card) => {
        index = Array.from(card.parentNode.children).indexOf(card)
        row = Math.floor(index / 5)
        rowElements = Array.from(card.parentNode.children).slice(row * 5, row * 5 + 5)
        rowText = ''
        rowElements.forEach(el => {
          rowText = rowText.concat(el.children[0].innerHTML)
        })

        return {
          word: rowText,
          rowElements
        }
      }
      const checkWordValidity = (word) => {
        response = JSON.parse(httpGet(`https://dictionaryapi.com/api/v3/references/collegiate/json/${word}?key=f9144e92-9061-4ab5-b46d-f4d37b23f330`))
        isValid = typeof response[0] === 'object'
        validWordDefinition = isValid ? response[0].shortdef[0] : ''

        return isValid
      }
      const setRowValidity = (rowElements, isValid) => {
        rowElements.forEach(el => {
          el.classList.add(isValid ? 'valid' : 'invalid')
          el.classList.remove(isValid ? 'invalid' : 'valid')
        })
      }
      const setDefinition = (word) => {
        validWordElement.innerHTML = word
        validWordDefinitionElement.innerHTML = validWordDefinition
      }
      const getGoogleSheetData = () => {
        letters = JSON.parse(localStorage.getItem(GOOGLE_SHEETS_LETTERS_KEY))
        if (!letters) {
          letters = JSON.parse(httpGet('https://sheets.googleapis.com/v4/spreadsheets/1oOqqvC7M6-1QptQOHYMdSbYF6ck9B6dBH1Ti6mn67GI/values/Scrabble?key=AIzaSyAeDaX2jPdYgDX7v9SOofwALTJlR4wkRYY')).values
          localStorage.setItem(GOOGLE_SHEETS_LETTERS_KEY, JSON.stringify(letters))
        }
        if (letters.length === 27) { // make sure the data looks right - 26 letters + 1 header
          googleSheetsLettersContainer.innerHTML = ''
          letters.forEach((l, i) => {
            letter = l[0]
            frequency = l[1]
            points = l[2]
            
            letterContainer = document.createElement('div')
            letterContainer.classList.add('google-sheets-letter-container')
            if (i === 0) { // header in Google Sheets
              letterElement = document.createElement('span')
              frequencyElement = document.createElement('span')
              pointsElement = document.createElement('span')
              letterElement.innerHTML = letter
              frequencyElement.innerHTML = frequency
              pointsElement.innerHTML = points
            } else {
              letterElement = document.createElement('span')
              frequencyElement = document.createElement('input')
              pointsElement = document.createElement('input')
              letterElement.innerHTML = letter
              frequencyElement.value = frequency
              frequencyElement.type = 'number'
              pointsElement.value = points
              pointsElement.type = 'number'
            }

            letterContainer.appendChild(letterElement)
            letterContainer.appendChild(frequencyElement)
            letterContainer.appendChild(pointsElement)
            googleSheetsLettersContainer.appendChild(letterContainer)
          })
        }
      }
      const updateLettersLocally = () => {
        googleSheetsLetters = Array.from(document.getElementsByClassName('google-sheets-letter-container'))
        if (googleSheetsLetters.length === 27) { // make sure the data looks right - 26 letters + 1 header
          letters = []
          googleSheetsLetters.forEach((l, i) => {
            letter = l.children[0].innerHTML
            if (i === 0) {
              frequency = l.children[1].innerHTML
              points = l.children[2].innerHTML
            } else {
              frequency = l.children[1].value
              points = l.children[2].value
            }

            letters.push([letter, frequency, points])
          })
          localStorage.setItem(GOOGLE_SHEETS_LETTERS_KEY, JSON.stringify(letters))

          resetBoard()
        }
      }

      const resetBoard = () => {
        LETTERS = JSON.parse(JSON.stringify(ORIGINAL_LETTERS))
        setupHands()
        handCards = Array.from(document.getElementsByClassName('card hand'))
        boardCards = Array.from(document.getElementsByClassName('card board'))
        handCards.forEach(card => {
          chooseRandomLetter(card)
          card.onclick = () => {
            if (card.parentNode.classList.contains('active') && card.children[0].innerHTML) {
              Array.from(card.parentNode.children).forEach(c => {
                c.classList.remove('active')
              })
              card.classList.add('active')
            }
          }
        })
        boardCards.forEach(card => {
          card.onclick = () => {
            isCorrectTurn = card.parentNode.classList.contains('active')
            selectedHandCard = document.getElementsByClassName('card hand active')[0]
            if (isCorrectTurn && selectedHandCard) {
              placeCard(card, selectedHandCard)
              const { word, rowElements } = getRowText(card)

              if (word.length === 5) {
                isValid = checkWordValidity(word)
                setRowValidity(rowElements, isValid)

                if (isValid) {
                  setDefinition(word)
                }
              }
            }
          }
        })  

        activePlayer = 0
        activeTeam = 0
        playSides[0].classList.add('active')
        playSides[1].classList.remove('active')
      }
      resetBoard()
    }
  </script>
</html>